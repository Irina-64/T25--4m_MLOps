# Лабораторная работа №13  
Полный CI/CD: от кода до обновления кластера + мониторинг дрейфа и авто-ретрейн

### Цель работы

Создать полностью автоматический CI/CD-пайплайн, который при слиянии в main:
- прогоняет тесты,
- собирает и пушит Docker-образ,
- деплоит приложение в Kubernetes.

Дополнительно (выполнено как опциональная часть):  
реализовать детекцию feature/performance drift, регулярный мониторинг и автоматический запуск переобучения модели при обнаружении значимого дрейфа.

---

## 1. Реализация CI/CD пайплайна (GitHub Actions)

Создан файл .github/workflows/deploy.yml, который выполняет следующие шаги при merge в main:

1. Тесты — pytest tests/
2. Сборка и пуш образа в GitHub Container Registry  
   → ghcr.io/mart1ny/team-2_detox/detox-api:latest
3. Автоматический деплой в Kubernetes  
   через kubectl set image deployment/detox-api api=... и kubectl rollout status

Доступ к кластеру реализован безопасно через секрет KUBECONFIG_BASE64 (base64-закодированный kubeconfig Minikube).

После каждого merge в main приложение в кластере обновляется менее чем за 3 минуты.

---

## 2. Реализация мониторинга дрейфа и авто-ретрейна

Создан второй workflow: .github/workflows/drift-monitoring.yml

### 2.1 Детекция дрейфа (Evidently AI)

- Сравнивается reference-датасет (train) с текущими продакшен-запросами (собираются в data/production_requests.csv)
- Вычисляются:
  - Feature drift (по PSI и KS для числовых признаков)
  - Performance drift (по доле токсичных предсказаний и распределению confidence)
- Генерируется HTML + JSON отчёт → сохраняется как Artifact в Actions

### 2.2 Регулярный запуск

- Workflow запускается по расписанию каждый день в 02:00 (schedule: cron '0 2 * * *')
- Также может запускаться вручную через workflow_dispatch

### 2.3 Автоматический триггер переобучения

Если дрейф значительный (PSI > 0.2 или доля drift-признаков > 30%):

- workflow отправляет repository_dispatch событие типа drift-detected
- Это событие ловит третий workflow retrain-and-deploy.yml, который:
  1. Запускает src/train.py → обучает новую модель
  2. Сохраняет её в MLflow Registry (stage → Production)
  3. Запускает job build-and-push и deploy (переиспользует шаги из основного пайплайна)
  4. Деплоит новую версию модели в кластер

Таким образом реализован полный замкнутый цикл: код → деплой → мониторинг → авто-ретрейн → новый деплой

### 2.4 Демонстрация работы системы

Искусственно смоделирован дрейф:
- В продакшен-запросы добавлены тексты с аномально высокой токсичностью и длиной
- PSI по признакам вырос до 0.35–0.47
- drift-monitoring.yml зафиксировал дрейф → отправил repository_dispatch
- Автоматически запустился полный ретрейн → новый образ → деплой
- В кластере появились поды с обновлённой моделью

Всё подтверждено логами GitHub Actions и артефактами.

---

## 3. Артефакты лабораторной работы

- .github/workflows/deploy.yml — основной CI/CD пайплайн
- .github/workflows/drift-monitoring.yml — мониторинг дрейфа
- .github/workflows/retrain-and-deploy.yml — авто-ретрейн при дрейфе
- Работающий Docker-образ в GHCR: https://github.com/mart1ny/team-2_detox/pkgs/container/team-2_detox
- Автоматически обновляемое приложение в Minikube (kubectl get pods)
- HTML-отчёты Evidently в Artifacts запусков
- Логи всех успешных деплоев и ретрейнов во вкладке Actions

---

## 4. Вывод

В ходе лабораторной работы реализована полноценная MLOps-инфраструктура:

- реализован полный автоматический CI/CD с деплоем в Kubernetes,
- реализована детекция feature и performance drift,
- настроен регулярный запуск проверки,
- добавлен автоматический триггер retraining,
- успешно смоделирован дрейф и показано, что система корректно реагирует на него.

Все цели лабораторной работы выполнены, включая опциональные пункты.

---

## Распределение задач в команде

Власюк Данил —  
- создал и отладил основной CI/CD пайплайн (deploy.yml)  
- настроил сборку и пуш в GHCR, автоматический деплой через kubectl  
- реализовал безопасный доступ к Minikube через секрет KUBECONFIG_BASE64

Скрыпник Михаил —  
- реализовал мониторинг дрейфа с помощью Evidently AI  
- настроил ежедневный scheduled workflow drift-monitoring.yml  
- генерировал и сохранял отчёты дрейфа как Artifacts  

Беспалый Максим —  
- реализовал автоматический запуск переобучения при дрейфе (repository_dispatch + retrain-and-deploy.yml)  
- интегрировал MLflow Registry и промоушен модели в Production  
- настроил полный цикл: дрейф → ретрейн → новый образ → деплой  

Провков Иван —  
- смоделировал дрейф данных в продакшен-трафике  
- провёл end-to-end тестирование всей системы мониторинга и авто-ретрейна  
- зафиксировал доказательства корректной работы (логи, артефакты, скриншоты)  

Яковенко Максим —  
- подготовил финальный отчёт по лабораторной работе  
- оформил документацию, собрал все ссылки и артефакты  
- обновил README с инструкциями по запуску и демонстрации